<div class="w-full max-w-md mx-auto p-4">
  <section class="card bg-base-100 shadow-sm" data-controller="toggle-form">
    <div class="card-body space-y-2">

      <!-- タイトル＆戻るボタン -->
      <div class="flex items-center justify-between mb-4">
        <h2 class="text-lg font-semibold">習慣編集</h2>

        <% back = request.referer %>
        <% back = nil if back == request.url %>

        <button
          type="button"
          class="btn btn-outline btn-xs flex items-center gap-1"
          onclick="window.location = '<%= back || habits_path %>'">
          <%= heroicon "arrow-uturn-left", variant: :outline, options: { class: "w-4 h-4" } %>
          戻る
        </button>
      </div>

      <%= form_with model: @habit_form,
                    url: habit_path(@habit_form.id),
                    method: :patch,
                    local: true do |f| %>

        <!-- ▼ 必須項目 -->
        <div class="space-y-4">
          <div class="border-l-4 border-primary/50 pl-3">
            <p class="text-base font-semibold">必須項目</p>
          </div>

          <!-- 状態管理 -->
          <div class="form-control">
            <%= f.label :status, "状態管理", class: "label-text text-sm font-semibold" %>
            <%= f.select :status,
                  Goal.statuses.keys.map { |k| [k.humanize, k] },
                  { prompt: "選択してください" },
                  class: "select select-bordered w-full" %>
            <p class="text-xs text-base-content/60 mt-1">
                この習慣の状態管理です。
            </p>
          </div>

          <!-- 名前 -->
          <div class="form-control">
            <%= f.label :name, "習慣名", class: "label-text text-sm font-semibold" %>
            <%= f.text_field :name,
              class: "input input-bordered w-full",
              placeholder: "例：日記、スクワット30回、読書10分" %>
          </div>

          <!-- カテゴリ -->
          <div class="form-control">
            <%= f.label :category_id, "カテゴリ", class: "label-text text-sm font-semibold" %>
            <%= f.select :category_id,
                  options_from_collection_for_select(
                    Category.all,
                    :id,
                    ->(c){ "#{c.icon} #{c.name}" },
                    @habit_form.category_id
                  ),
                  { prompt: "選択してください" },
                  class: "select select-bordered w-full" %>
            <p class="text-xs text-base-content/60 mt-2">
              カテゴリは行動の種類です（例：運動、睡眠、食事、暮らし）
            </p>
          </div>

          <!-- ▼ 達成頻度（frequency） -->
          <div class="form-control">
            <%= f.label :frequency, "達成頻度", class: "label-text text-sm font-semibold" %>
            <%= f.select :frequency,
                  Goal.frequencies.keys.map { |k| [k.humanize, k] },
                  { prompt: "選択してください" },
                  class: "select select-bordered w-full" %>
          </div>

          <!-- ▼ 目標タイプ（goal_unit） + セット数（amount） -->
          <div class="form-control" data-controller="amount">
            <%= f.label :goal_unit, "目標タイプ", class: "label-text text-sm font-semibold" %>
            <%= f.select :goal_unit,
                  Goal.goal_units.keys.map { |k| [k.humanize, k] },
                  { prompt: "例：チェック / 回数で管理 / 時間で管理" },
                  class: "select select-bordered w-full",
                  data: {action: "change->amount#toggle"},
                  "data-amount-target": "typeSelect" %>

            <div data-amount-target="amountField"
                class="<%= @habit_form.goal_unit.in?(%w[count_based time_based]) ? '' : 'hidden' %> mt-3">
              <%= f.label :amount, "目標値", class: "label-text text-sm font-semibold" %>
              <%= f.number_field :amount, min: 1,
                    class: "input input-bordered w-full",
                    placeholder: "例：3（＝週3回実施）" %>
            </div>
          </div>
        </div>

        <!-- ▼ 任意項目 -->
        <div data-toggle-form-target="details"
             class="hidden space-y-4">

          <div class="border-b border-base-300 mt-4 mb-4"></div>

          <div class="border-l-4 border-secondary pl-3">
            <p class="text-base font-semibold">任意項目</p>
          </div>

          <!-- 期間設定 -->
          <div>
            <p class="text-sm font-semibold mb-1">期間設定</p>
            <div class="grid grid-cols-2 gap-4">
              <div class="form-control">
                <%= f.date_field :start_date, class: "input input-bordered w-full" %>
              </div>
              <div class="form-control">
                <%= f.date_field :end_date, class: "input input-bordered w-full" %>
              </div>
            </div>
          </div>

          <!-- 説明欄 -->
          <div class="form-control">
            <%= f.label :description, "説明欄", class: "label-text text-sm font-semibold" %>
            <%= f.text_area :description, rows: 3,
                  class: "textarea textarea-bordered w-full",
                  placeholder: "例：毎日スクワットを30回して身体を整える習慣です" %>
          </div>
        </div>

        <!-- ▼ ボタン -->
        <div class="w-[90%] mx-auto flex gap-4 mt-6">

          <button type="submit"
                  class="btn btn-primary btn-sm flex-1 px-3 flex items-center justify-center gap-2">
            <%= heroicon "check", options: { class: "w-4 h-4" } %>
            更新する
          </button>

          <button type="button"
                  class="btn btn-outline btn-sm flex-1 px-3 flex items-center justify-center gap-2"
                  data-action="toggle-form#toggle">
            <span data-toggle-form-target="icon">+</span>
            <span data-toggle-form-target="label">任意項目</span>
          </button>

        </div>

      <% end %>

    </div>
  </section>
</div>
