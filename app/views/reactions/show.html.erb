<div class="space-y-6">

  <!-- ヘッダー -->
  <div class="flex items-center justify-between">
    <%= link_to "←", reaction_path(date: @date.prev_day.to_s), class: "btn btn-sm btn-ghost" %>
    <div>
      <h1 class="text-lg font-bold">振り返り</h1>
      <p class="text-xs text-base-content/60"><%= l(@date, format: :long) %></p>
    </div>
    <%= link_to "→", reaction_path(date: @date.next_day.to_s), class: "btn btn-sm btn-ghost" %>
  </div>

  <!-- 今日のサマリー -->
  <div class="grid grid-cols-2 gap-3">
    <!-- 気分結果 -->
    <div class="card bg-base-100 shadow-sm">
      <div class="card-body p-4">
        <div class="text-xs text-base-content/60">平均気分</div>

        <% if @avg_mood.present? %>
          <div class="mt-1 flex items-baseline gap-2">
            <div class="text-2xl font-bold"><%= format("%.1f", @avg_mood) %></div>
            <div class="text-xs text-base-content/50">/ 5</div>
          </div>
          <p class="mt-2 text-xs text-base-content/60">
            <%= daily_mood_text(@avg_mood, @mood_logs) %>
          </p>
        <% else %>
          <div class="mt-2 text-sm text-base-content/50">記録なし</div>
          <div class="mt-2 text-xs text-base-content/60">
            今日はまだ気分ログがありません
          </div>
        <% end %>
      </div>
    </div>

    <!-- 行動結果 -->
    <div class="card bg-base-100 shadow-sm" data-controller="swiper">
      <div class="card-body p-4">
        <div class="space-y-2">
        <!-- 1行目：行動率 -->
        <div class="text-xs text-base-content/60">
          行動率
        </div>

        <!-- 2行目：ボタン群（均等配置） -->
        <div
          class="grid grid-cols-3 gap-2"
          role="tablist"
          aria-label="行動率切替"
        >
          <% ["毎日", "毎週", "毎月"].each_with_index do |label, i| %>
            <button
              type="button"
              role="tab"
              data-index="<%= i %>"
              data-swiper-target="tab"
              data-action="click->swiper#slideTo"
              class="px-3 py-1 text-xs font-semibold rounded-btn text-center"
              aria-selected="<%= i.zero? %>"
            >
              <%= label %>
            </button>
          <% end %>
        </div>
      </div>

        <!-- Swiper -->
        <div class="swiper w-full mt-4" data-swiper-target="container">
          <div class="swiper-wrapper">

            <!-- ========== 今日（毎日行動） ========== -->
            <div class="swiper-slide space-y-2">
              <% if @daily_habits.count.to_i.positive? %>
                <div class="flex items-baseline gap-2">
                  <div class="text-2xl font-bold">
                    <%= @daily_rate || 0 %><span class="text-base font-bold">%</span>
                  </div>
                </div>

                <div class="text-xs text-base-content/60">
                  今日は
                  <span class="font-semibold">
                    <%= @daily_done %> / <%= @daily_total %>
                  </span>
                  記録
                </div>

                <div class="text-xs text-base-content/50">
                  <%= daily_achievement_text(@daily_rate) %>
                </div>
              <% else %>
                <div class="text-sm text-base-content/50">対象の行動はありません</div>
                <div class="text-xs text-base-content/60">
                  行動を登録すると、ここに表示されます
                </div>
              <% end %>
            </div>

            <!-- ========== 今週（週次行動） ========== -->
            <div class="swiper-slide space-y-2">
              <% if @weekly_total.to_i.positive? %>
                <div class="text-sm font-semibold">
                  <%= @weekly_done %> / <%= @weekly_total %> 回
                </div>
                <div class="text-xs text-base-content/60">
                  今週の進捗
                </div>
              <% else %>
                <div class="text-sm text-base-content/50">
                  今週の行動はありません
                </div>
              <% end %>
            </div>

            <!-- ========== 今月（月次行動） ========== -->
            <div class="swiper-slide space-y-2">
              <% if @monthly_total.to_i.positive? %>
                <div class="text-sm font-semibold">
                  <%= @monthly_done %> / <%= @monthly_total %> 回
                </div>
                <div class="text-xs text-base-content/60">
                  今月の進捗
                </div>
              <% else %>
                <div class="text-sm text-base-content/50">
                  今月の行動はありません
                </div>
              <% end %>
            </div>

          </div>
        </div>

      </div>
    </div>
  </div>

  <!-- 行動 × 気分 -->
  <div class="card bg-base-100 shadow-sm">
    <div class="card-body p-4">
      <div class="flex items-center justify-between">
        <h2 class="text-sm font-bold">行動と気分</h2>
      </div>

      <div class="mt-3 space-y-2">
        <% @habit_summaries.each do |h| %>
          <div class="flex items-center justify-between rounded-lg bg-base-200/60 p-3">
            <div class="min-w-0">
              <div class="flex items-center gap-2">
                <span class="text-base"><%= h[:habit].category&.icon %></span>
                <div class="truncate text-sm font-semibold"><%= h[:habit].name %></div>
                <% if h[:done] %>
                  <% if h[:achieved] %>
                  <span class="badge badge-primary badge-outline text-xs">
                    <%= t("habit.progress_status.achieved") %>
                  </span>
                  <% else %>
                    <span class="badge badge-primary badge-outline text-xs">
                      <%= h[:progress].total_value %> / <%= h[:progress].target_value %>
                    </span>
                  <% end %>
                <% else %>
                  <span class="badge badge-ghost text-xs">未実行</span>
                <% end %>
              </div>

              <% if h[:done] %>
                <div class="mt-1 text-xs text-base-content/60">
                  <%# mood 表示はあなたのモデルに合わせて（name / value など） %>
                  before: <%= h[:before_mood]&.label || "—" %>
                  ／ after: <%= h[:after_mood]&.label || "—" %>
                  <% if h[:started_at].present? %>
                    <span class="ml-2 text-base-content/40"><%= l(h[:started_at], format: :short) %></span>
                  <% end %>
                </div>
              <% else %>
                <div class="mt-1 text-xs text-base-content/50">
                  記録なし
                </div>
              <% end %>
            </div>

            <div class="ml-3 shrink-0">
              <%= link_to "詳細", habit_path(h[:habit]), data: { turbo_frame: "modal" }, class: "btn btn-xs btn-ghost" %>
            </div>
          </div>
        <% end %>
      </div>
    </div>
  </div>

  <!-- ④ ログ一覧（下に置く：補助資料） -->
  <div class="card bg-base-100 shadow-sm">
    <div class="card-body p-4">
      <div class="flex items-center justify-between">
        <h2 class="text-sm font-bold">ログ一覧</h2>
      </div>

      <div class="mt-3 space-y-2">
        <% if @habit_logs.any? %>
          <% @habit_logs.each do |log| %>
            <div class="rounded-lg bg-base-200/60 p-3">
              <div class="flex items-center justify-between">
                <div class="text-sm font-semibold truncate">
                  <span class="mr-1"><%= log.habit.category&.icon %></span>
                  <%= log.habit.name %>
                </div>
                <div class="text-xs text-base-content/50">
                  <%= l(log.started_at, format: :short) %>
                </div>
              </div>
              <% before_log = log.mood_logs.before.max_by(&:recorded_at) %>
              <% after_log = log.mood_logs.after.max_by(&:recorded_at) %>
              <div class="mt-1 text-xs text-base-content/60">
                行動前: <%= "#{emoji_for_label(before_log&.mood&.label)} #{jp_label_for_label(before_log&.mood&.label)}" || "—" %>
                ／ 行動後: <%= "#{emoji_for_label(before_log&.mood&.label)} #{jp_label_for_label(before_log&.mood&.label)}" || "—" %>
              </div>
            </div>
          <% end %>
        <% else %>
          <div class="text-sm text-base-content/50">この日の行動ログはありません</div>
        <% end %>

        <% if @mood_logs.any? %>
          <div class="divider my-2">気分ログ</div>
          <% @mood_logs.each do |m| %>
            <div class="rounded-lg bg-base-200/60 p-3">
              <div class="flex items-center justify-between">
                <div class="text-sm font-semibold"><%= "#{emoji_for_label(m.mood&.label)} #{jp_label_for_label(m.mood&.label)}" || "気分" %></div>
                <div class="text-xs text-base-content/50"><%= l(m.recorded_at, format: :short) %></div>
              </div>
              <% if m.feeling.present? %>
                <div class="mt-1 text-xs text-base-content/60"><%= m.feeling.name %></div>
              <% end %>
              <% if m.note.present? %>
                <div class="mt-1 text-xs text-base-content/60 whitespace-pre-wrap"><%= m.note %></div>
              <% end %>
            </div>
          <% end %>
        <% end %>
      </div>
    </div>
  </div>

</div>
