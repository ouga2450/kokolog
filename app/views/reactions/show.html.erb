<div class="space-y-6">

  <!-- ヘッダー -->
  <div class="flex items-center justify-between">
    <%= link_to "←", reaction_path(date: @date.prev_day.to_s), class: "btn btn-sm btn-ghost" %>
    <div>
      <h1 class="text-lg font-bold">振り返り</h1>
      <p class="text-xs text-base-content/60"><%= l(@date, format: :long) %></p>
    </div>
    <%= link_to "→", reaction_path(date: @date.next_day.to_s), class: "btn btn-sm btn-ghost" %>
  </div>

  <!-- ① 今日のサマリー（数字あり / でも責めない） -->
  <div class="grid grid-cols-2 gap-3">
    <div class="card bg-base-100 shadow-sm">
      <div class="card-body p-4">
        <div class="text-xs text-base-content/60">平均気分</div>

        <% if @avg_mood.present? %>
          <div class="mt-1 flex items-baseline gap-2">
            <div class="text-2xl font-bold"><%= format("%.1f", @avg_mood) %></div>
            <div class="text-xs text-base-content/50">/ 5</div>
          </div>
          <div class="mt-2 text-xs text-base-content/60">
            今日の空気を数字で確認できます
          </div>
        <% else %>
          <div class="mt-2 text-sm text-base-content/50">記録なし</div>
          <div class="mt-2 text-xs text-base-content/60">
            今日はまだ気分ログがありません
          </div>
        <% end %>
      </div>
    </div>

    <div class="card bg-base-100 shadow-sm">
      <div class="card-body p-4">
        <div class="text-xs text-base-content/60">習慣達成率</div>

        <% if @habits_count.positive? %>
          <div class="mt-1 flex items-baseline gap-2">
            <div class="text-2xl font-bold">
              <%= @achievement_rate || 0 %><span class="text-base font-bold">%</span>
            </div>
          </div>

          <div class="mt-2 text-xs text-base-content/60">
            今日は <span class="font-semibold"><%= @completed_habits_count %> / <%= @habits_count %></span> 達成
          </div>

          <%# 責めない：未達成でもニュートラルな言い方だけ %>
          <% if (@achievement_rate || 0) == 0 %>
            <div class="mt-2 text-xs text-base-content/50">
              今日はここまで。記録が残るだけで十分です
            </div>
          <% end %>
        <% else %>
          <div class="mt-2 text-sm text-base-content/50">対象の習慣なし</div>
          <div class="mt-2 text-xs text-base-content/60">
            まずは習慣を登録すると達成率が表示されます
          </div>
        <% end %>
      </div>
    </div>
  </div>

  <!-- ② 行動 × 気分（断定しない） -->
  <div class="card bg-base-100 shadow-sm">
    <div class="card-body p-4">
      <div class="flex items-center justify-between">
        <h2 class="text-sm font-bold">行動と気分</h2>
        <div class="text-xs text-base-content/50">断定はしません</div>
      </div>

      <div class="mt-3 space-y-2">
        <% @habit_summaries.each do |h| %>
          <div class="flex items-center justify-between rounded-lg bg-base-200/60 p-3">
            <div class="min-w-0">
              <div class="flex items-center gap-2">
                <span class="text-base"><%= h[:habit].category&.icon %></span>
                <div class="truncate text-sm font-semibold"><%= h[:habit].name %></div>
                <% if h[:done] %>
                  <span class="badge badge-primary badge-outline text-xs">達成</span>
                <% else %>
                  <span class="badge badge-ghost text-xs">未実行</span>
                <% end %>
              </div>

              <% if h[:done] %>
                <div class="mt-1 text-xs text-base-content/60">
                  <%# mood 表示はあなたのモデルに合わせて（name / value など） %>
                  before: <%= h[:before_mood]&.label || "—" %>
                  ／ after: <%= h[:after_mood]&.label || "—" %>
                  <% if h[:started_at].present? %>
                    <span class="ml-2 text-base-content/40"><%= l(h[:started_at], format: :short) %></span>
                  <% end %>
                </div>
              <% else %>
                <div class="mt-1 text-xs text-base-content/50">
                  記録なし
                </div>
              <% end %>
            </div>

            <div class="ml-3 shrink-0">
              <%= link_to "詳細", habit_path(h[:habit]), data: { turbo_frame: "modal" }, class: "btn btn-xs btn-ghost" %>
            </div>
          </div>
        <% end %>
      </div>
    </div>
  </div>

  <!-- ③ 言語化ゾーン（強制しない） -->
  <div class="card bg-base-100 shadow-sm">
    <div class="card-body p-4">
      <h2 class="text-sm font-bold">今日のひとこと</h2>
      <p class="mt-1 text-xs text-base-content/60">数字にできない部分を残しておけます</p>

      <%# ここはあなたの実装に合わせてフォームに差し替え（例: DailyNote / LogSummary など） %>
      <div class="mt-3">
        <div class="rounded-lg bg-base-200/60 p-3 text-sm text-base-content/60">
          （ここにメモ機能を後で接続）
          <div class="mt-1 text-xs text-base-content/40">例：今日は眠くてペースが落ちた</div>
        </div>
      </div>
    </div>
  </div>

  <!-- ④ ログ一覧（下に置く：補助資料） -->
  <div class="card bg-base-100 shadow-sm">
    <div class="card-body p-4">
      <div class="flex items-center justify-between">
        <h2 class="text-sm font-bold">ログ一覧</h2>
        <div class="text-xs text-base-content/50">確認したいときだけ</div>
      </div>

      <div class="mt-3 space-y-2">
        <% if @habit_logs.any? %>
          <% @habit_logs.each do |log| %>
            <div class="rounded-lg bg-base-200/60 p-3">
              <div class="flex items-center justify-between">
                <div class="text-sm font-semibold truncate">
                  <span class="mr-1"><%= log.habit.category&.icon %></span>
                  <%= log.habit.name %>
                </div>
                <div class="text-xs text-base-content/50">
                  <%= l(log.started_at, format: :short) %>
                </div>
              </div>
              <% before_log = log.mood_logs.before.max_by(&:recorded_at) %>
              <% after_log = log.mood_logs.after.max_by(&:recorded_at) %>
              <div class="mt-1 text-xs text-base-content/60">
                before: <%= before_log&.mood&.label || "—" %>
                ／ after: <%= after_log&.mood&.label || "—" %>
              </div>
            </div>
          <% end %>
        <% else %>
          <div class="text-sm text-base-content/50">この日の習慣ログはありません</div>
        <% end %>

        <% if @mood_logs.any? %>
          <div class="divider my-2">気分ログ</div>
          <% @mood_logs.each do |m| %>
            <div class="rounded-lg bg-base-200/60 p-3">
              <div class="flex items-center justify-between">
                <div class="text-sm font-semibold"><%= m.mood&.label || "気分" %></div>
                <div class="text-xs text-base-content/50"><%= l(m.recorded_at, format: :short) %></div>
              </div>
              <% if m.feeling.present? %>
                <div class="mt-1 text-xs text-base-content/60"><%= m.feeling.name %></div>
              <% end %>
              <% if m.note.present? %>
                <div class="mt-1 text-xs text-base-content/60 whitespace-pre-wrap"><%= m.note %></div>
              <% end %>
            </div>
          <% end %>
        <% end %>
      </div>
    </div>
  </div>

</div>
