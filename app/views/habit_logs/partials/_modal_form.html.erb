<%= turbo_frame_tag "modal_content" do %>
  <div class="space-y-6">

    <!-- タイトル -->
    <div class="flex items-center justify-between border-b border-base-300 pb-2">
      <h3 class="font-bold text-lg text-base-content flex items-center gap-2">
        <span class="text-2xl"><%= habit_log.habit.category.icon %></span>
        <%= habit_log.habit.name %>
      </h3>

      <span class="badge badge-primary badge-outline text-xs px-2 py-1">
        <%= habit_log.persisted? ? "習慣編集" : "習慣実行" %>
      </span>
    </div>

    <!-- フォームバリデーションのエラーメッセージ -->
    <% if habit_log.errors.any? %>
      <div class="alert alert-soft alert-error max-sm:alert-vertical text-xs font-bold mb-4">
        <div class="flex items-start gap-2">
          <%= heroicon "x-circle", variant: :outline, options: { class: "w-5 h-5 flex-shrink-0" } %>
          <ul class="list-none space-y-1">
            <% habit_log.errors.full_messages.each do |message| %>
              <li><%= message %></li>
            <% end %>
          </ul>
        </div>
      </div>
    <% end %>

    <!-- destroy_failure での固定メッセージ -->
    <% if local_assigns[:errors] %>
      <div class="alert alert-soft alert-error max-sm:alert-vertical text-xs font-bold mb-4">
        <div class="flex items-start gap-2">
          <%= heroicon "x-circle", variant: :outline, options: { class: "w-5 h-5 flex-shrink-0" } %>
          <span>削除に失敗しました。もう一度お試しください。</span>
        </div>
      </div>
    <% end %>

    <!-- 目標値 (新規追加) -->
    <div class="bg-base-200/60 p-3 rounded-lg text-sm">
      <span class="font-semibold text-base-content/80">目標：</span>
      <%= habit_log.habit.goal.display_goal %>
    </div>

    <!-- フォーム -->
    <%= form_with model: habit_log,
                  data: { turbo_frame: "modal" } do |f| %>

      <!-- hidden -->
      <%= f.hidden_field :habit_id, value: habit_log.habit.id %>
      <%= f.hidden_field :goal_id,  value: habit_log.goal.id %>
      <%= hidden_field_tag :dom_from, params[:dom_from] || "home" %>
      <%= hidden_field_tag :from, params[:from] || "edit" %>

      <!-- ▼ 今日の実行量 -->
      <% if habit_log.goal.goal_unit != "check_based" %>
        <div class="form-control mt-4">
          <%= f.label :performed_value, "今日の実行量", class: "label-text text-sm font-semibold" %>

          <% if habit_log.goal.goal_unit == "count_based" %>
            <%= f.number_field :performed_value,
                  min: 0,
                  class: "input input-bordered w-full",
                  placeholder: "例：30（回）" %>

          <% elsif habit_log.goal.goal_unit == "time_based" %>
            <%= f.number_field :performed_value,
                  min: 0,
                  class: "input input-bordered w-full",
                  placeholder: "例：15（分）" %>
          <% end %>
        </div>
      <% end %>

      <!-- 開始時刻 -->
      <div class="form-control mt-4">
        <%= f.label :started_at, "開始時刻", class: "label-text font-semibold text-base-content/80" %>
        <%= f.datetime_local_field :started_at,
              class: "input input-bordered w-full",
              value: habit_log.started_at&.strftime("%Y-%m-%dT%H:%M") %>
      </div>

      <p class="text-xs text-base-content/60">
        ※ 実際に始めた時間に調整できます
      </p>

      <!-- ▼ 気分入力するかどうか -->
      <div class="form-control mt-4">
        <label class="label cursor-pointer flex justify-start gap-2">
          <%= f.check_box :input_mood_after, { class: "checkbox checkbox-sm" }, true, false %>
          <span class="label-text text-sm">この後、気分を入力する</span>
        </label>
      </div>

      <!-- アクションボタン -->
      <div class="modal-action flex justify-between items-center pt-4 border-t border-base-300">
        <div class="flex gap-2">
          <%= f.submit "#{habit_log.persisted? ? "更新" : "記録"}" , class: "btn btn-sm btn-primary h-9 min-h-9 px-4" %>
          <% if @habit_log.persisted? %>
            <%= link_to "削除",
                      habit_log_path(habit_log, dom_from: params[:dom_from], from: params[:from]),
                      data: { turbo_method: :delete, turbo_confirm: "本当に削除しますか？" },
                      class: "btn btn-sm btn-outline btn-error h-9 min-h-9 px-4" %>
          <% end %>
        </div>

        <button type="button"
                data-action="click->modal#close"
                class="btn btn-sm btn-outline h-9 min-h-9 px-4">
          閉じる
        </button>
      </div>
    <% end %>
  </div>
<% end %>
